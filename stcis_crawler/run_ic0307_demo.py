# run_ic0307_demo.py
from stcis_driver import make_driver, open_ic0307
from stcis_tabs import go_stop_usage_tab
from stcis_dates import set_period_js
from stcis_region import set_region_gyeongnam_changwon
from stcis_stop import search_stop, count_modal_rows, pick_modal_by_global_index, close_modal
from stcis_actions import click_query_results
from stcis_download import click_download
import re, os

# ── 설정값
START_YMD = "2025-08-18"
END_YMD   = "2025-08-25"
STOP_NAMES = [
    #"내봉촌",
    #"갈전운동장",
    #"분포",
    #"신전입구",
    #"본포",
    #"중촌",
    #"앞실마을입구",
    # "송정종점",
    # "송정",
    # "가곡마을",
    # "전촌",
    # "봉촌",
    # "신목",
    # "북모산마을",
    # "소라",
    # "전촌입구",
    # "남모산",
    # "원봉강",
    # "용연입구",
    # "북면온천",
    # "북면농협",
    # "월계",
    # "산남",
    # "죽동마을",
    # "죽동",
    # "산남입구",
    # "봉강",
    # "북면지구대",
    # "곡안리",
    # "진전초교",
    # "옹기골",
    # "도산마을",
    # "암하",
    # "아래주도",
    # "진목마을",
    # "천주교마산교구청",
    # "광암선창",
    # "진전어린이집",
    # "주도입구",
    # "옥계입구",
    # "고현",
    # "진전면행정복지센터",
    # "오서시장",
    # "진전중학교",
    # "오서입구",
    # "고현수협조합",
    # "선두종점",
    # "장기",
    # "내포마을",
    # "미리마을",
    # "호산마을",
    # "회동",
    # "정달마을",
    # "신촌마을",
    # "욱곡마을회관앞",
    # "이명마을입구",
    # "욱곡용궁횟집",
    # "옥계종점",
    # "이명마을",
    # "욱곡마을",
    # "탑동종점",
    # "욱곡입구",
    # "망향정입구",
    # "창포마을",
    # "반동삼거리",
    # "구산농협",
    # "창포",
    # "춘추원",
    # "붉은등대",
    # "난포리",
    # "장구리",
    # "동진대교",
    # "연까치",
    # "장수암입구",
    # "범바위",
    # "소포",
    # "청등골",
    # "공원관리사무실",
    # "연산홍단지.무궁단지",
    # "경남선교120주년기념관",
    # "동백단지.라단지",
    # "창원공원묘원1단지",
    # "천지애단지",
    # "매화단지",
    # "창원공원정문",
    # "속천어촌계",
    # "내평마을",
    # "합성동농협",
    # "동양테크윈",
    # "유니시티3단지",
    # "한우아파트",
    # "웅천우체국",
    # "서북동마을",
    # "시영1차아파트",
    # "동전산단",
    # "석전동",
    # "경남대",
    # "장천종점",
    # "평성입구",
    # "토월고등학교",
    # "주도",
    # "진해역(진해역주차앞)",
    # "상룡",
    # "용담마을",
    # "금산초등학교",
    # "김해국토관리사무소",
    # "동산",
    # "사산",
    # "서천",
    # "우동",
    # "오척",
    # "하계",
    # "대정마을",
    # "방동",
    # "보훈요양원",
    # "효동마을",
    # "아랫양지",
    # "윗양지",
    # "용전",
    # "의창스포츠센터",
    # "의창구청",
    # "서부경찰서(원흥사)",
    # "명서초등학교",
    # "명서시장",
    # "명곡다리(명곡교회)",
    # "명서1민원센터",
    # "시티7",
    # "창원컨벤션센터",
    # "문성고등학교",
    # "창원종합운동장",
    # "노블파크아파트",
    # "트리비앙아파트(한국폴리텍대학)",
    # "창원중앙고등학교",
    # "창원시청",
    # "창원시청(정우상가)",
    # "상남시장(은아아파트)",
    # "시민생활체육관",
    # "대동백화점",
    # "토월성원아파트",
    # "상남도서관",
    # "상남도서관(한림.우성아파트)",
    # "가음정시장",
    # "가음정시장(더샵센트럴파크)",
    # "장미공원",
    # "도태",
    # "송등",
    # "성심원",
    # "북면행정복지센터",
    # "춘광아파트",
    # "북면연동",
    # "윗대방",
    # "섬김의집",
    # "북면공설운동장",
    # "봉곡",
    # "대호아파트",
    # "마산리",
    # "대방",
    # "양교",
    # "현천",
    # "중리경로당",
    # "대산초등학교",
    # "신촌주유소",
    # "합산",
    # "가술",
    # "가촌",
    # "영신아파트",
    # "금동",
    # "용산입구",
    # "용산",
    # "북면양촌",
    # "백양마을",
    # "신음",
    # "신동이주단지",
    # "신동마을",
    # "명호마을",
    # "월산",
    # "월촌",
    # "월촌교",
    # "남백마을종점",
    # "동전(14)",
    # "마룡",
    # "동전",
    # "무동센텀파라디아아파트",
    # "무동입구",
    # "주남",
    # "석산",
    # "까치골",
    # "1366경남센터",
    # "고양이주단지",
    # "대천",
    # "윗용호",
    # "구복",
    # "시락",
    # "시락마을",
    # "해변횟집",
    # "별장입구",
    # "상심리",
    # "설진",
    # "원전종점",
    # "저도연육교.스카이워크",
    # "아랫용호",
    # "정곡",
    # "시락정곡종점",
    # "미천마을",
    # "상평종점",
    # "용마고등학교",
    # "육호광장",
    # "어울림어린이공원",
    # "한국가스안전공사",
    # "남부터미널",
    # "상곡동",
    # "해운중학교",
    # "방송통신대",
    # "마산합포스포츠센터",
    # "가포신항",
    # "감천입구",
    # "광려중학교",
    # "내서여고",
    # "두척",
    # "유목교",
    # "마산역.365병원",
    # "3.15아트센터",
    # "오동동아구찜거리",
    # "공단회관",
    # "신등초등학교",
    # "상등",
    # "장등",
    # "남모산종점",
    # "제동마을",
    # "유청",
    # "송정주공아파트",
    # "성진3차아파트",
    # "산인농공단지",
    # "수동마을",
    # "대천마을",
    # "학산",
    # "광복동",
    # "함안역",
    # "함안",
    # "군농협",
    # "함안종점",
    # "산인면사무소",
    # "해동아파트 후문",
    # "터미널입구",
    # "학산마을",
    # "장미공원(가음은아아파트)",
    # "롯데아울렛(기점)",
    # "롯데워터파크",
    # "롯데아울렛",
    # "율하2지구입구",
    # "율하2지구상가",
    # "율하자이",
    # "원메이저푸르지오",
    # "뜰천",
    # "율현주공후문",
    # "율하파출소(남명엔스퀘어)",
    # "서부문화센터",
    # "율하e-편한",
    # "율현주공",
    # "동원로얄듀크1차",
    # "농협수남지점",
    # "율하초등학교",
    # "모산초등학교",
    # "김해스포츠센터",
    # "창원펫빌리지",
    # "정우상가(가로변)",
    # "안골버스회차지",
    # "풍유동차고지",
    # "용원고등학교",
    # "용원",
    # "웅동2동행정복지센터",
    # "청량산터널앞",
    # "옥녀봉입구",
    # "판신",
    # "감계리",
    # "고양",
    # "주남저수지",
    # "노스빌골프랜드",
    # "가월마을입구",
    # "화목",
    # "승산초등학교",
    # "가월입구",
    # "감계입구",
    # "곡목",
    # "내감",
    # "화천리",
    # "다호",
    # "중방마을",
    # "고암마을",
    # "무점종점",
    # "모암",
    # "북면새터",
    # "한수",
    # "칠성아파트",
    # "중재골입구",
    # "외감",
    # "외감입구",
    # "대한마을",
    # "무성마을입구",
    # "신방",
    # "지개리",
    # "용잠.동읍행정복지센터",
    # "달천산림욕장",
    # "산수정",
    # "동읍지구대",
    # "성진1차아파트",
    # "용잠삼거리",
    # "자여민원센터",
    # "굴현고개",
    # "용전마을",
    # "용정",
    # "동읍덕산마을",
    # "성진5차아파트",
    # "외단계",
    # "용전.남산마을입구",
    # "천주암",
    # "용암",
    # "용강검문소",
    # "동정동갓골",
    # "신우타워",
    # "소답초등학교",
    # "입곡마을",
    # "신당마을",
    # "불모산종점",
    # "좌곤육교",
    # "좌곤",
    # "대근아파트",
    # "서구",
    # "중구",
    # "진영농협(진영전통시장)",
    # "진영시외주차장",
    # "제일고등학교",
    # "기영아파트",
    # "진영종점",
    # "진영",
    # "제암요양병원",
    # "진영제일고등학교",
    # "부곡",
    # "신용삼거리",
    # "봉곡상가",
    # "곡촌",
    # "무기",
    # "구성삼거리",
    # "칠원삼거리",
    # "신영장미아파트",
    # "칠원고교",
    # "에이스아파트",
    # "천계마을",
    # "창동마을",
    # "삼영엠텍입구",
    # "태곡",
    # "칠서변전소",
    # "대치",
    # "공단사거리",
    # "칠서정수장입구",
    # "부성모델종점",
    # "부성모텔종점",
    # "관리공단",
    # "칠서공단",
    # "산성자전거",
    # "영신사거리",
    # "용산사거리",
    # "이현",
    # "칠원식육점",
    # "칠원우체국",
    # "무기마을",
    # "석전마을",
    # "유등",
    # "월계마을회관",
    # "마산리경로당",
    # "갈전",
    # "창원종합폐차장",
    # "화천기전",
    # "삼우정밀",
    # "대원기전",
    # "대동정밀",
    # "윤화스너",
    # "대영정공",
    # "삼현정밀",
    # "미래기전",
    # "LG산전",
    # "향교입구",
    # "창원초등학교",
    # "소답상가",
    # "북동공설시장",
    # "흥한웰가아파트",
    # "동일그린맨션",
    # "안성종점",
    # "동정동/써니마트",
    # "청년주유소",
    # "동정동/더서울병원",
    # "호계",
    # "오성아파트",
    # "안곡마을",
    # "도계동만남의광장",
    # "윤병원",
    # "의창동환승센터",
    # "금호온천",
    # "의창사거리",
    # "소답동",
    # "도계동",
    # "용담종점",
    # "한마음아파트",
    # "서상삼거리",
    # "마산대학교종점",
    # "안성새터마을",
    # "창원여중",
    # "호계농협",
    # "도계초등학교",
    # "북부",
    # "경상고교",
    # "평성마을",
    "소계종점입구",
    "수곡",
    "창원역",
    "마산대학교정문",
    "동서병원",
    "창원웨딩의전당",
    "소계입구",
    "소계시장",
    "대남종합상가",
    "창원중고등학교",
    "소계동",
    "팔룡동행정복지센터",
    "극동아파트",
    "죽암",
    "대지아파트",
    "장미파크맨션",
    "경남테크노파크",
    "팔룡동",
    "서광맨션",
    "사화초등학교",
    "팔룡중학교",
    "팔룡동입구",
    "구미동",
    "수영아파트",
    "경남스틸",
    "내덕",
    "명법2통",
    "명법1통",
    "풍유2통",
    "대법륜사",
    "일동한신아파트",
    "삼문마을",
    "오곡",
    "북면출장소방소",
    "완암사거리",
    "연덕로",
    "남산중학교",
]


DOWNLOAD_DIR = "/Users/TEMP.BOOK-QDV4PVA41A.000/Desktop/study/project/2025/changwon_drt/data"

def _safe(s: str) -> str:
    return re.sub(r"[\\/:*?\"<>|]", "_", s or "").strip()

def _prep_driver():
    drv = make_driver(headless=False, download_dir=DOWNLOAD_DIR)
    open_ic0307(drv)
    go_stop_usage_tab(drv)
    set_period_js(drv, START_YMD, END_YMD)
    set_region_gyeongnam_changwon(drv)
    return drv

def main():
    for stop_name in STOP_NAMES:
        drv = _prep_driver()
        search_stop(drv, stop_name)
        total = count_modal_rows(drv)

        if total == 0:
            print(f"'{stop_name}' 검색 결과 없음 → 스킵")
            close_modal(drv)
            drv.quit()
            continue

        drv.quit()
        print(f"'{stop_name}' 검색된 행 개수: {total}")

        for idx in range(total):
            drv = _prep_driver()
            search_stop(drv, stop_name)
            pick_modal_by_global_index(drv, idx)
            click_query_results(drv)

            basename = f"{_safe(stop_name)}_{START_YMD}_{END_YMD}_row{idx+1:03d}"
            save_path = click_download(drv, download_dir=DOWNLOAD_DIR, desired_basename=basename)
            print(f"[{stop_name}] [{idx+1}/{total}] 저장 완료: {save_path}")
            drv.quit()

if __name__ == "__main__":
    main()